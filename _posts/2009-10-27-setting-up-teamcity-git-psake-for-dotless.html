---
layout: post
title: "Setting up TeamCity + git + psake for dotless"
guid: http://www.tigraine.at/2009/10/27/setting-up-teamcity-git-psake-for-dotless/
postid: 790
categories:
- net
- programmierung
- projects
- tools
- dotless
---
<p>Let me say one thing upfront: Setting this up has been a HUGE pain in the ass (PITA for short), and I really hope this gets fixed sometime in the future, because those 3 hours I just spent getting this done are never coming back.. </p>  <p>Ok, just to make sure everybody understands: dotless is built using a PSake build script that has to be run through Powershell. The script itself calls out to git and therefore relies on git being installed into the PATH. </p>  <p><strong>First: Git-Teamcity</strong></p>  <p>Since our build relies on executing a git command during build the official JetBrains plugin doesn’t cut it (it only copies the sources, not the .git folder). So I downloaded <a href="http://github.com/chrisortman/git-teamcity">git-teamcity from GitHub</a> and built it using maven (at least something worked). </p>  <p>After that <a href="http://www.knowledgetree.com/blog/continuous-integration-with-teamcity-git">I followed this tutorial</a> on how to install the plugin on TeamCity:</p>  <blockquote>   <ul>     <li>package the plugin by following the steps outlined in file pkg in the Git plugin folder: create a folder<strong>gitAgent/lib</strong> in the folder <strong>target</strong>, copy all the .jar files (should only be <strong>Git-vcs.jar</strong>) to this folder, and then zip <strong>gitAgent</strong> to <strong>gitAgent.zip</strong> </li>      <li>deploy the plugin by following the steps outlined in file deploy in the Git plugin folder: copy<strong>gitAgent.zip to</strong> <strong>\webapps\ROOT\update\plugins</strong>, and copy <strong>Git-vcs.jar</strong> to<strong>\webapps\ROOT\WEB-INF\lib</strong> </li>   </ul> </blockquote>  <p>Well, after setting up a new VCS Root inside TeamCity the most important part is to set the VCS checkout mode to <strong>“Automatically on agent (if supported by VCS roots)”</strong></p>  <p><img style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="image" border="0" alt="image" src="http://www.tigraine.at/wp-content/uploads/2009/10/image2.png" width="577" height="159" /> </p>  <p>Warning: Also make sure that you have git installed at C:\Program Files\git, because that is <a href="http://github.com/jlewallen/git-teamcity/blob/b714bafe7bd8e41444b320fd7f3d9350f1d3008b/src/main/java/org/hivedb/teamcity/plugin/GitConfiguration.java#L76">the only place git-teamcity will look</a> for the bin (unless you change the code).</p>  <p></p>  <p><strong>Second: Execute Powershell</strong></p>  <p>Apparently there is some major bug with the ConsoleRunner inside TeamCity so all attempts to simply run the Powershell didn’t work. Directly invoking Powershell led to the build timing out. After some digging I found this thread that explained the problem and hinted at a possible solution: <a href="http://www.jetbrains.net/devnet/thread/275854">Touble with Powershell and NAnt during build</a></p>  <p>So, I created a .bat file called TeamCity.bat that calls Powershell directly from it’s full path (C:\Windows\System32\…) like this:</p>  <blockquote><tt>     <p>C:\WINDOWS\system32\windowspowershell\v1.0\Powershell.exe .\psake.ps1</p>   </tt></blockquote>  <p>But this doesn’t work due to the above bug in TeamCity. The build kept hanging and eventually got terminated due to an timeout. So I had to change it to something like this:</p>  <blockquote><tt>     <p>echo abc | C:\WINDOWS\system32\windowspowershell\v1.0\powershell.exe .\psake.ps1</p>   </tt></blockquote>  <p>Putting echo in front of it made it work, I have no idea why, but id worked.    <br />Now the next problem came up: although I explicitly ran Set-Executionpolicy on the box the runner’s executionpolicy was not set. So I added the Set-Executionpolicy to the .bat file:</p>  <blockquote><tt>     <p>echo abc | C:\WINDOWS\system32\windowspowershell\v1.0\powershell.exe Set-ExecutionPolicy remotesigned        <br />echo abc | C:\WINDOWS\system32\windowspowershell\v1.0\powershell.exe .\psake.ps1</p>   </tt></blockquote>  <p>Now, finally the script was executing, but due to no environment variables, my buildscript could not locate git (due to the ConsoleRunner not having ANY environment variables present). </p>  <p>The final version of my TeamCity.bat then included a change to the PATH variable and it finally worked:</p>  <blockquote style="margin-right: 0px" dir="ltr">   <p><tt>Set &quot;path=%path%;C:\Program Files\git\bin&quot;&#160; <br />echo abc | C:\WINDOWS\system32\windowspowershell\v1.0\powershell.exe Set-ExecutionPolicy remotesigned         <br />echo abc | C:\WINDOWS\system32\windowspowershell\v1.0\powershell.exe .\psake.ps1</tt></p> </blockquote>  <p>At that point the build was finally executing and I then only had to tell TeamCity where to find the build artifacts and I was done. </p>  <p><strong>Conclusion</strong></p>  <p>Now that it works, I’m glad I took the time to set it up. But the process could have gone smoother.    <br />Anyway, the good news is:</p>  <p>You can now get a release version from every future commit to the dotless repository right from <a href="http://dotlesscss.com:8081/viewType.html?buildTypeId=bt3&amp;tab=buildTypeStatusDiv">our dotless TeamCity server</a>!</p>