---
layout: post
title: "Exporting Data to CVS in ASP.NET"
guid: http://www.tigraine.at/?p=298
postid: 298
--- # categories
- .NET
- Coding
---
<p>So, today I tried the ASP.NET Wiki that's currently in Beta and thought, best way to do so is to expand an article. I'll blog about my Wiki experience later, but for now I'd like to share my code on this one.</p>  <p>I started out with the Wiki Article <a href="http://wiki.asp.net/page.aspx/401/export-to-csv-file/">Export to CSV file</a> (<a href="http://wiki.asp.net/page.aspx/401/export-to-csv-file/rev/3">revision 3</a>) and thought on how to improve it.</p>  <p>As you may have noticed, the topic at hand is so simple, it doesn't really need improving, except for the main flaw where you have to specify all column headers in code.</p>  <p>My take on this was to use the DataBinder API from the System.Web.UI namespace and remove the whole HttpContext.Current stuff to an instance variable so it's easier to test the stuff and you can put it into a class library (if you want that).</p>  <p>Let's assume I have a list of type Person I want to write to CSV</p>  <div style="padding-right: 0px; padding-left: 0px; padding-bottom: 0px; margin: 0px; padding-top: 0px; display: inline" id="scid:2e6d557b-b705-4c34-b5ad-8606cf99c7de:3867c41b-69e5-42a3-8d27-9a7bb052187d" class="wlWriterSmartContent"><pre name="code" class="csharp">
public class Person
{
&#160;&#160;&#160;&#160;public String Name
&#160;&#160;&#160;&#160;{ get; set; }
&#160;&#160;&#160;&#160;public String Family
&#160;&#160;&#160;&#160;{ get; set; }
&#160;&#160;&#160;&#160;public int Age
&#160;&#160;&#160;&#160;{ get; set; }
&#160;&#160;&#160;&#160;public decimal Salary
&#160;&#160;&#160;&#160;{ get; set; }
}
</pre></div>

<p>Now here's the CVSExporter class that you just need to pass 3 things: Your List&lt;Person&gt;, your HttpContext.Current and a List&lt;String&gt; that specifies what columns you want printed out (eg. Name, Family).</p>

<div style="padding-right: 0px; padding-left: 0px; padding-bottom: 0px; margin: 0px; padding-top: 0px; display: inline" id="scid:2e6d557b-b705-4c34-b5ad-8606cf99c7de:a9cd5d82-8fa9-4b9e-b723-0b1e52ee0843" class="wlWriterSmartContent"><pre name="code" class="csharp">
public class CSVExporter
{
&#160;&#160;&#160;&#160;public static void WriteToCSV(List&lt;Object&gt; dataList, HttpContext httpContext, List&lt;String&gt; columnNames)
&#160;&#160;&#160;&#160;{
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;InitializeHeaders(httpContext);

&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;WriteColumnNames(httpContext, columnNames);
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;foreach (Object data in dataList)
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;{
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;WriteData(data, httpContext, columnNames);
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;}
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;httpContext.Response.End(); //Everything has to end.. 
&#160;&#160;&#160;&#160;}

&#160;&#160;&#160;&#160;private static void InitializeHeaders(HttpContext httpContext)
&#160;&#160;&#160;&#160;{
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;string attachment = "attachment; filename=PersonList.csv";
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;httpContext.Response.Clear();
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;httpContext.Response.ClearHeaders();
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;httpContext.Response.ClearContent();
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;httpContext.Response.AddHeader("content-disposition", attachment);
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;httpContext.Response.ContentType = "text/csv";
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;httpContext.Response.AddHeader("Pragma", "public");
&#160;&#160;&#160;&#160;}

&#160;&#160;&#160;&#160;private static void WriteData(Object data, HttpContext httpContext, List&lt;String&gt; columnNames)
&#160;&#160;&#160;&#160;{
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;StringBuilder stringBuilder = new StringBuilder();
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;foreach (String column in columnNames)
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;{
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;AddComma(
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;System.Web.UI.DataBinder.Eval(data, column).ToString(), 
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;stringBuilder);
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;}
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;httpContext.Response.Write(stringBuilder.ToString());
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;httpContext.Response.Write(Environment.NewLine);
&#160;&#160;&#160;&#160;}

&#160;&#160;&#160;&#160;private static void AddComma(string value, StringBuilder stringBuilder)
&#160;&#160;&#160;&#160;{
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;stringBuilder.AppendFormat("{0}, ", value.Replace(',', ' '));
&#160;&#160;&#160;&#160;}

&#160;&#160;&#160;&#160;private static void WriteColumnNames(HttpContext httpContext, List&lt;String&gt; columnNames)
&#160;&#160;&#160;&#160;{
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;StringBuilder stringBuilder = new StringBuilder();
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;foreach (String column in columnNames)
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;{
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;stringBuilder.AppendFormat("{0}, ", column);
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;}
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;httpContext.Response.Write(stringBuilder.ToString());
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;httpContext.Response.Write(Environment.NewLine);
&#160;&#160;&#160;&#160;}

}
</pre></div>

<p>So that's it for now. I guess there is still room for improvement, and if you need performance you should go with the original solution, DataBinder.Eval does some type-casting internally so it won't run at lightning speeds, but you get the idea of what can be done with the DataBinder control :).</p>

<p>And now I'm off to writing a Windows Live Writer Plugin that will allow me to paste longer code without jumping through loops like a madman (I posted the code in my Wordpress admin-gui because doing it from wlv simply didn't work!)</p>